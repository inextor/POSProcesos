<div class="container-fluid">
	<h1 class="my-3">Reporte de Movimientos de Items - Todas las Sucursales</h1>
	<div class="card p-3">
		<div class="row">
			<div class="col-6 col-md-4">
				<label>Fecha Inicial</label>
				<input type="datetime-local" name="start_date" class="form-control" [(ngModel)]="start_date" (ngModelChange)="onDateChange($event, item_movement_search.eq, 'start_timestamp')">
			</div>
			<div class="col-6 col-md-4">
				<label>Fecha Final</label>
				<input type="datetime-local" name="end_date" class="form-control" [(ngModel)]="end_date" (ngModelChange)="onDateChange($event, item_movement_search.eq, 'end_timestamp', '', 59)">
			</div>
			<div class="col-12 col-md-4">
				<button type="button" class="btn btn-primary w-100" (click)="this.search(item_movement_search)">
					<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" width="1.3em" height="1.3em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128c0-70.7 57.2-128 128-128c70.7 0 128 57.2 128 128c0 70.7-57.2 128-128 128z" fill="currentColor"/></svg>
					Buscar
				</button>
			</div>
		</div>
	</div>

	<div class="card p-3 mt-3">
		@if (is_loading) {
			<div class="text-center">
				<div class="spinner-border" role="status">
					<span class="visually-hidden">Cargando...</span>
				</div>
			</div>
		} @else {
			<table class="table table-bordered">
				<thead>
					<tr>
						<th class="sortable" (click)="sortBy('item_id')">
							ID
							@if (sortColumn === 'item_id') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable" (click)="sortBy('item_name')">
							Articulo
							@if (sortColumn === 'item_name') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable" (click)="sortBy('item_code')">
							Código
							@if (sortColumn === 'item_code') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable text-end" (click)="sortBy('total_requested')">
							Requeridos
							@if (sortColumn === 'total_requested') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable text-end" (click)="sortBy('total_produced')">
							Producidos
							@if (sortColumn === 'total_produced') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable text-end">Costo de produccion</th>
						<th class="sortable text-end" (click)="sortBy('total_received')">
							Recibidos
							@if (sortColumn === 'total_received') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable text-end" (click)="sortBy('total_sold')">
							Vendidos
							@if (sortColumn === 'total_sold') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable text-end" (click)="sortBy('sold_amount')">
							Ventas
							@if (sortColumn === 'sold_amount') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable text-end" (click)="sortBy('total_merma')">
							Merma
							@if (sortColumn === 'total_merma') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable text-end" (click)="sortBy('total_merma')">
							Costo de Merma
							@if (sortColumn === 'total_merma') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
						<th class="sortable text-end">Precio de referencia</th>
												<th class="sortable text-end" (click)="sortBy('total_gain')">
							Utilidad
							@if (sortColumn === 'total_gain') {
								<span>{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
							}
						</th>
					</tr>
				</thead>
				<tbody>
					@for(item of item_movement_list; track $index)
					{
						<tr>
							<td>{{item.item_id}}</td>
							<td>{{item?.category?.name}} - {{item.item_name}}</td>
							<td>{{item.item_code}}</td>
							<td class="text-end">{{item.reference_price|currency}}</td>
							<td class="text-end">{{item.total_requested|number}}</td>
							<td class="text-end">{{item.total_produced|number}}</td>
							<td class="text-end">{{item.production_cost|currency}}</td>
							<td class="text-end">{{item.total_received| number}}</td>
							<td class="text-end">{{item.total_merma|number}}</td>
							<td class="text-end">{{item.total_merma*item.reference_price|currency}}</td>
							<td class="text-end">{{item.total_sold|number}}</td>
							<td class="text-end">{{item.sold_amount|currency}}</td>
							<td class="text-end" [ngClass]="{'text-danger': item.text_danger}">
								{{item.total_gain|currency}}
							</td>
						</tr>
					}
					@empty {
						<tr>
							<td class="text-center" colspan="12">No se encontraron resultados</td>
						</tr>
					}
				</tbody>
				<tfoot>
					<tr class="table-secondary fw-bold">
						<td colspan="3" class="text-end">TOTALES:</td>
						<td class="text-end">{{total_reference_price|currency}}</td>
						<td class="text-end">{{total_requested|number}}</td>
						<td class="text-end">{{total_produced|number}}</td>
						<td class="text-end">{{total_production_cost|currency}}</td>
						<td class="text-end">{{total_received|number}}</td>
						<td class="text-end">{{total_merma|number}}</td>
						<td class="text-end">{{total_merma_cost|number}}</td>
						<td class="text-end">{{total_sold|number}}</td>
						<td class="text-end">{{total_sold_amount|currency}}</td>
						<td class="text-end">{{total_gain|currency}}</td>
					</tr>
				</tfoot>
			</table>
		}
	</div>
</div>
