<div class="container-fluid">
	<h4>Resumen de Proveedor</h4>

	<div class="card mb-3">
		<div class="card-body">
			<div class="row">
				<div class="col-md-4">
					<label class="form-label">Proveedor</label>
					<select class="form-select" [(ngModel)]="purchase_search.eq.provider_user_id" (change)="performSearch()">
						<option [ngValue]="null">-- Seleccionar Proveedor --</option>
						@for(provider of providers; track provider.id)
						{
							<option [ngValue]="provider.id">{{provider.name}}</option>
						}
					</select>
				</div>
				<div class="col-md-3">
					<label class="form-label">Fecha Inicio</label>
					<input type="datetime-local" class="form-control" [ngModel]="start_date" (ngModelChange)="onDateChange($event, purchase_search.ge, 'created', '00:00:00')">
				</div>
				<div class="col-md-3">
					<label class="form-label">Fecha Fin</label>
					<input type="datetime-local" class="form-control" [ngModel]="end_date" (ngModelChange)="onDateChange($event, purchase_search.le, 'created', '23:59:59')">
				</div>
				<div class="col-md-2 d-flex align-items-end">
					<button class="btn btn-primary w-100" (click)="performSearch()">Buscar</button>
				</div>
			</div>
		</div>
	</div>

	@if(is_loading)
	{
		<div class="text-center py-5">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Cargando...</span>
			</div>
		</div>
	}

	@if(!is_loading && selected_provider)
	{
		<div class="card mb-3">
			<div class="card-header">
				<h5 class="mb-0">Proveedor: {{selected_provider.name}}</h5>
			</div>
			<div class="card-body">
				<div class="row text-center">
					<div class="col-md-3">
						<h6>Total Compras</h6>
						<h4>{{purchase_list.length}}</h4>
					</div>
					<div class="col-md-3">
						<h6>Total Comprado</h6>
						<h4>{{totalPurchased | number:'1.0-2'}}</h4>
					</div>
					<div class="col-md-3">
						<h6>Total Recibido</h6>
						<h4>{{totalReceived | number:'1.0-2'}}</h4>
					</div>
					<div class="col-md-3">
						<h6>Total Merma</h6>
						<h4 class="text-danger">{{totalMerma | number:'1.0-2'}}</h4>
					</div>
				</div>
			</div>
		</div>

		@if(item_summary_list.length > 0)
		{
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0">Resumen por Articulo</h5>
				</div>
				<div class="card-body p-0">
					<div class="table-responsive">
						<table class="table table-striped table-hover mb-0">
							<thead class="table-dark">
								<tr>
									<th class="cursor-pointer" (click)="sortBy('item_code')">
										Codigo
										@if(sortColumn === 'item_code')
										{
											<span>{{sortDirection === 'asc' ? '&#9650;' : '&#9660;'}}</span>
										}
									</th>
									<th class="cursor-pointer" (click)="sortBy('item_name')">
										Articulo
										@if(sortColumn === 'item_name')
										{
											<span>{{sortDirection === 'asc' ? '&#9650;' : '&#9660;'}}</span>
										}
									</th>
									<th class="cursor-pointer" (click)="sortBy('category_name')">
										Categoria
										@if(sortColumn === 'category_name')
										{
											<span>{{sortDirection === 'asc' ? '&#9650;' : '&#9660;'}}</span>
										}
									</th>
									<th class="text-end cursor-pointer" (click)="sortBy('qty_purchased')">
										Comprado
										@if(sortColumn === 'qty_purchased')
										{
											<span>{{sortDirection === 'asc' ? '&#9650;' : '&#9660;'}}</span>
										}
									</th>
									<th class="text-end cursor-pointer" (click)="sortBy('qty_received')">
										Recibido
										@if(sortColumn === 'qty_received')
										{
											<span>{{sortDirection === 'asc' ? '&#9650;' : '&#9660;'}}</span>
										}
									</th>
									<th class="text-end cursor-pointer" (click)="sortBy('qty_merma')">
										Merma
										@if(sortColumn === 'qty_merma')
										{
											<span>{{sortDirection === 'asc' ? '&#9650;' : '&#9660;'}}</span>
										}
									</th>
									<th class="text-end">Pendiente</th>
									<th class="text-end cursor-pointer" (click)="sortBy('total_purchased')">
										Total
										@if(sortColumn === 'total_purchased')
										{
											<span>{{sortDirection === 'asc' ? '&#9650;' : '&#9660;'}}</span>
										}
									</th>
								</tr>
							</thead>
							<tbody>
								@for(item of item_summary_list; track item.item_id)
								{
									<tr>
										<td>{{item.item_code || '-'}}</td>
										<td>{{item.item_name}}</td>
										<td>{{item.category_name || '-'}}</td>
										<td class="text-end">{{item.qty_purchased | number:'1.0-2'}}</td>
										<td class="text-end">{{item.qty_received | number:'1.0-2'}}</td>
										<td class="text-end text-danger">{{item.qty_merma | number:'1.0-2'}}</td>
										<td class="text-end text-warning">{{item.qty_purchased - item.qty_received - item.qty_merma | number:'1.0-2'}}</td>
										<td class="text-end">${{item.total_purchased | number:'1.2-2'}}</td>
									</tr>
								}
							</tbody>
							<tfoot class="table-secondary">
								<tr>
									<th colspan="3">TOTALES</th>
									<th class="text-end">{{totalPurchased | number:'1.0-2'}}</th>
									<th class="text-end">{{totalReceived | number:'1.0-2'}}</th>
									<th class="text-end text-danger">{{totalMerma | number:'1.0-2'}}</th>
									<th class="text-end text-warning">{{totalPurchased - totalReceived - totalMerma | number:'1.0-2'}}</th>
									<th class="text-end">${{totalAmount | number:'1.2-2'}}</th>
								</tr>
							</tfoot>
						</table>
					</div>
				</div>
			</div>
		}
		@else if(!is_loading)
		{
			<div class="alert alert-info">
				No se encontraron compras para este proveedor en el rango de fechas seleccionado.
			</div>
		}

		@if(purchase_list.length > 0)
		{
			<div class="card mt-3">
				<div class="card-header">
					<h5 class="mb-0">Detalle de Compras</h5>
				</div>
				<div class="card-body p-0">
					<div class="table-responsive">
						<table class="table table-striped table-hover mb-0">
							<thead class="table-dark">
								<tr>
									<th>ID</th>
									<th>Fecha</th>
									<th class="text-end">Total</th>
									<th>Estado Stock</th>
									<th>Envios</th>
								</tr>
							</thead>
							<tbody>
								@for(purchase of purchase_list; track purchase.purchase.id)
								{
									<tr>
										<td>
											<a [routerLink]="['/purchase/edit', purchase.purchase.id]">
												#{{purchase.purchase.id}}
											</a>
										</td>
										<td>{{purchase.purchase.created | shortDate}}</td>
										<td class="text-end">${{purchase.purchase.total | number:'1.2-2'}}</td>
										<td>
											@switch(purchase.purchase.stock_status)
											{
												@case('PENDING')
												{
													<span class="badge bg-warning">Pendiente</span>
												}
												@case('ADDED_TO_STOCK')
												{
													<span class="badge bg-success">Agregado</span>
												}
												@case('SHIPPING_CREATED')
												{
													<span class="badge bg-info">Envio Creado</span>
												}
											}
										</td>
										<td>
											@if(purchase.shippings.length > 0)
											{
												<span class="badge bg-primary">{{purchase.shippings.length}} envio(s)</span>
											}
											@else
											{
												<span class="badge bg-secondary">Sin envios</span>
											}
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		}
	}

	@if(!is_loading && !purchase_search.eq.provider_user_id)
	{
		<div class="alert alert-warning">
			Seleccione un proveedor para ver el resumen.
		</div>
	}
</div>
